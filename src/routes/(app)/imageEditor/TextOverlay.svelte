<!-- 
@file: /src/routes/(app)/imageEditor/TextOverlay.svelte
@description: This component allows users to overlay text onto an image in the image editor.
              Users can adjust the text content, font size, color, alignment, and style.
              The text is draggable, and the component supports multiple text overlays on the canvas.
-->

<script lang="ts">
	import Konva from 'konva';
	import { createEventDispatcher, onMount } from 'svelte';

	interface Props {
		stage: Konva.Stage;
		layer: Konva.Layer;
		imageNode: Konva.Image;
	}

	let { stage, layer, imageNode }: Props = $props();

	let text = $state('');
	let fontSize = $state(24);
	let textColor = $state('#ffffff');
	let fontFamily = $state('Arial');
	let textAlign = $state('left');
	let fontStyle = $state('normal');
	let selectedText: Konva.Text | null = $state(null);

	const dispatch = createEventDispatcher();

	onMount(() => {
		stage.on('click', (e) => {
			if (e.target instanceof Konva.Text) {
				selectText(e.target);
			} else {
				deselectText();
			}
		});
	});

	function addText() {
		if (!text) return;

		const textNode = new Konva.Text({
			x: imageNode.width() / 2,
			y: imageNode.height() / 2,
			text: text,
			fontSize: fontSize,
			fontFamily: fontFamily,
			fill: textColor,
			align: textAlign,
			fontStyle: fontStyle,
			draggable: true
		});

		textNode.on('transform', () => {
			textNode.setAttrs({
				width: textNode.width() * textNode.scaleX(),
				scaleX: 1
			});
		});

		layer.add(textNode);
		layer.draw();
		selectText(textNode);
		text = '';
	}

	function selectText(textNode: Konva.Text) {
		deselectText();
		selectedText = textNode;
		selectedText.draggable(true);
		addTransformer(selectedText);
		layer.draw();
	}

	function deselectText() {
		if (selectedText) {
			selectedText.draggable(false);

			// Use findOne if you expect a single Transformer
			const transformer = stage.findOne('Transformer');
			if (transformer) {
				transformer.destroy();
			}

			layer.draw();
			selectedText = null;
		}
	}

	function addTransformer(textNode: Konva.Text) {
		const tr = new Konva.Transformer({
			nodes: [textNode],
			enabledAnchors: ['middle-left', 'middle-right'],
			boundBoxFunc: (oldBox, newBox) => {
				newBox.width = Math.max(30, newBox.width);
				return newBox;
			}
		});
		layer.add(tr);
	}

	function updateSelectedText() {
		if (selectedText) {
			selectedText.setAttrs({
				fontSize: fontSize,
				fill: textColor,
				fontFamily: fontFamily,
				align: textAlign,
				fontStyle: fontStyle
			});
			layer.draw();
		}
	}

	function deleteSelectedText() {
		if (selectedText) {
			// Destroy the selected text node
			selectedText.destroy();

			// Find and destroy the transformer
			const transformer = stage.findOne('Transformer');
			if (transformer) {
				transformer.destroy();
			}

			// Find and destroy the transformer
			layer.draw();
			// Clear the selected text reference
			selectedText = null;
		}
	}

	function resetTextOverlay() {
		layer.find('Text').forEach((textNode) => textNode.destroy());
		layer.find('Transformer').forEach((transformer) => transformer.destroy());
		layer.draw();

		text = '';
		fontSize = 24;
		textColor = '#ffffff';
		fontFamily = 'Arial';
		textAlign = 'left';
		fontStyle = 'normal';
		selectedText = null;
	}

	function exitTextOverlay() {
		dispatch('exitTextOverlay');
	}
</script>

<!-- Text Overlay Controls UI -->
<div class="wrapper">
	<h3 class=" relative text-center text-lg font-bold text-tertiary-500 dark:text-primary-500">Text Overlay</h3>

	<button onclick={exitTextOverlay} class="variant-ghost-primary btn-icon absolute -top-2 right-2 font-bold"> Exit </button>

	<input type="text" bind:value={text} onkeydown={(e) => e.key === 'Enter' && addText()} placeholder="Enter text" class="input" />

	<div class="flex items-center justify-between space-x-2">
		<input type="number" bind:value={fontSize} oninput={updateSelectedText} min="8" max="72" class="input w-16" />
		<input type="color" bind:value={textColor} oninput={updateSelectedText} class="h-8 w-8" />
		<select bind:value={fontFamily} onchange={updateSelectedText} class="input select">
			<option value="Arial">Arial</option>
			<option value="Helvetica">Helvetica</option>
			<option value="Times New Roman">Times New Roman</option>
			<option value="Courier New">Courier New</option>
		</select>
	</div>
	<div class="flex items-center justify-between space-x-2">
		<select bind:value={textAlign} onchange={updateSelectedText} class="input select">
			<option value="left">Left</option>
			<option value="center">Center</option>
			<option value="right">Right</option>
		</select>
		<select bind:value={fontStyle} onchange={updateSelectedText} class="input select">
			<option value="normal">Normal</option>
			<option value="bold">Bold</option>
			<option value="italic">Italic</option>
			<option value="bold italic">Bold Italic</option>
		</select>
	</div>
	<div class="flex justify-between space-x-2">
		<button onclick={deleteSelectedText} class="variant-filled-error btn" disabled={!selectedText}> Delete Selected </button>
		<button onclick={resetTextOverlay} class="variant-outline btn"> Reset </button>
		<button onclick={addText} class="variant-filled-primary btn"> Add Text </button>
	</div>
</div>
