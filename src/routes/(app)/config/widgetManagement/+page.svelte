<script lang="ts">
	import { onMount } from 'svelte';

	// ParaglideJS
	import * as m from '@src/paraglide/messages';

	// Component
	import PageTitle from '@components/PageTitle.svelte';

	type Widget = {
		name: string;
		status: 'active' | 'inactive';
	};

	let installedWidgets: Widget[] = $state([]);
	let activeWidgets: string[] = []; // Placeholder until implemented

	onMount(async () => {
		try {
			const widgets = await loadWidgets(); // Replace with actual implementation
			activeWidgets = await getActiveWidgets(); // Replace with actual implementation
			installedWidgets = widgets.map((widget) => ({
				...widget,
				status: activeWidgets.includes(widget.name) ? 'active' : 'inactive'
			}));
		} catch (error) {
			console.error('Failed to load widgets:', error);
			// Display an error message to the user
		}
	});

	async function loadWidgets(): Promise<Widget[]> {
		// Implement your logic to fetch installed widgets from the server or local storage
		return []; // Replace with actual implementation
	}

	async function getActiveWidgets(): Promise<string[]> {
		// Implement your logic to fetch currently active widgets from the server or local storage
		return []; // Replace with actual implementation
	}

	async function toggleWidgetStatus(widget: Widget) {
		const newStatus = widget.status === 'active' ? 'inactive' : 'active';
		try {
			// Implement your logic to update the widget status
			await updateWidgetStatus(widget.name, newStatus);
			widget.status = newStatus;
		} catch (error) {
			console.error(`Failed to update widget status for ${widget.name}:`, error);
			// Display an informative message to the user about the failure
		}
	}

	// Example implementation of updateWidgetStatus
	async function updateWidgetStatus(widgetName: string, newStatus: string) {
		// Implement your logic to update the widget status
		// This might involve calling an API endpoint or updating a local data store
		console.log(`Updating widget status for ${widgetName} to ${newStatus}`);
	}
</script>

<!-- Page Title with Back Button -->
<PageTitle name="Widget Management" icon="mdi:widgets" showBackButton={true} backUrl="/config" />

{#each installedWidgets as widget}
	<div class="my- flex items-center justify-between border-b pb-2">
		<span>{widget.name}</span>
		<button class="ml-4 rounded border px-4 py-2" onclick={() => toggleWidgetStatus(widget)}>
			{widget.status === 'active' ? 'Deactivate' : 'Activate'}
		</button>
	</div>
{/each}

{#if installedWidgets.length === 0}
	<p class="my-2 text-center text-tertiary-500 dark:text-primary-500">
		There are currently no widgets available. Visit the SveltyCMS marketplace to find new widgets and extend your system.
	</p>

	<a
		href="https://www.sveltyCMS.com"
		target="_blank"
		rel="noopener noreferrer"
		aria-label={m.config_Martketplace()}
		class="variant-ghost-primary btn w-full gap-2 py-6"
	>
		<iconify-icon icon="icon-park-outline:shopping-bag" width="28" class="text-white"></iconify-icon>
		<p class="uppercase">{m.config_Martketplace()}</p>
	</a>
{/if}
