<script lang="ts">
	import { onMount } from 'svelte';

	// Stores
	import { page } from '$app/stores';
	import { writable } from 'svelte/store';

	// Auth
	import type { Role, Permission } from '@src/auth/types';
	import { authAdapter } from '@src/databases/db';

	// Components
	import Loading from '@components/Loading.svelte';

	// Define the roles and permissions store
	const roles = writable<Role[]>([]);
	const selectedRoles = writable<Set<string>>(new Set());
	let roleName = '';
	let roleDescription = '';
	const availablePermissions = writable<Permission[]>([]);
	const selectedPermissions = writable<Set<string>>(new Set());
	const isLoading = writable(true);
	const error = writable<string | null>(null);

	$: currentUserId = $page.data.user?._id || '';

	onMount(async () => {
		try {
			// await initializationPromise;

			// // Check if authAdapter is initialized
			// if (!authAdapter) {
			// 	throw new Error('Auth adapter is not initialized');
			// }

			await loadRoles();
			await loadPermissions();
		} catch (err) {
			error.set(`Failed to initialize: ${err instanceof Error ? err.message : String(err)}`);
		} finally {
			isLoading.set(false);
		}
	});

	const loadRoles = async () => {
		try {
			// Ensure authAdapter is initialized
			// if (!authAdapter) {
			// 	throw new Error('Auth adapter is not initialized');
			// }

			// const rolesData = await authAdapter.getAllRoles();
			// roles.set(rolesData);
			roles.set($page.data.roles);
		} catch (err) {
			error.set(`Failed to load roles: ${err instanceof Error ? err.message : String(err)}`);
		}
	};

	const loadPermissions = async () => {
		try {
			// Ensure authAdapter is initialized
			// if (!authAdapter) {
			// 	throw new Error('Auth adapter is not initialized');
			// }

			// const permissionsData = await authAdapter.getAllPermissions();
			// availablePermissions.set(permissionsData);
			availablePermissions.set($page.data.permissions);
		} catch (err) {
			error.set(`Failed to load permissions: ${err instanceof Error ? err.message : String(err)}`);
		}
	};

	const addRole = async () => {
		if (!roleName) return;

		const roleData: Partial<Role> = {
			name: roleName,
			description: roleDescription,
			permissions: new Set($selectedPermissions) // Correctly use $ to access the store's value
		};

		try {
			// Ensure authAdapter is initialized
			if (!authAdapter) {
				throw new Error('Auth adapter is not initialized');
			}

			await authAdapter.createRole(roleData, currentUserId);
			roleName = '';
			roleDescription = '';
			selectedPermissions.set(new Set());
			await loadRoles();
		} catch (err) {
			error.set(`Failed to add role: ${err instanceof Error ? err.message : String(err)}`);
		}
	};

	const deleteSelectedRoles = async () => {
		try {
			// Ensure authAdapter is initialized
			if (!authAdapter) {
				throw new Error('Auth adapter is not initialized');
			}

			for (const roleId of $selectedRoles) {
				// Use $ to access the store's value
				await authAdapter.deleteRole(roleId, currentUserId);
			}
			selectedRoles.set(new Set());
			await loadRoles();
		} catch (err) {
			error.set(`Failed to delete roles: ${err instanceof Error ? err.message : String(err)}`);
		}
	};

	const toggleRoleSelection = (roleId: string) => {
		selectedRoles.update((selected) => {
			if (selected.has(roleId)) {
				selected.delete(roleId);
			} else {
				selected.add(roleId);
			}
			return selected;
		});
	};

	const togglePermissionSelection = (permissionId: string) => {
		selectedPermissions.update((selected) => {
			if (selected.has(permissionId)) {
				selected.delete(permissionId);
			} else {
				selected.add(permissionId);
			}
			return selected;
		});
	};
</script>

{#if $isLoading}
	<Loading customTopText="Loading Roles..." customBottomText="Please wait while roles are being loaded." />
{:else if $error}
	<p class="error">{$error}</p>
{:else}
	<div class="my-4">
		<h3 class="text-lg font-semibold">Roles Management</h3>
		<div class="mb-4">
			<input type="text" bind:value={roleName} placeholder="Role Name" class="mb-2 w-full rounded border p-2" />
			<textarea bind:value={roleDescription} placeholder="Role Description" class="mb-2 w-full rounded border p-2"></textarea>
			<div class="flex flex-wrap gap-2">
				{#each $availablePermissions as permission (permission._id)}
					<label class="flex items-center">
						<input
							type="checkbox"
							checked={$selectedPermissions.has(permission.name)}
							on:change={() => togglePermissionSelection(permission.name)}
							class="mr-2"
						/>
						<span>{permission.name}</span>
					</label>
				{/each}
			</div>
			<button on:click={addRole} class="mt-2 rounded bg-blue-500 px-4 py-2 text-white">Add Role</button>
			<button on:click={deleteSelectedRoles} class="ml-2 mt-2 rounded bg-red-500 px-4 py-2 text-white">Delete Selected Roles</button>
		</div>

		<div class="mt-4">
			<h4 class="mb-2">Existing Roles</h4>
			{#if $roles.length === 0}
				<p>No roles defined yet.</p>
			{:else}
				<ul class="list-disc pl-5">
					{#each $roles as role (role._id)}
						<!-- Assuming 'id' is the correct property -->
						<li class="flex items-center">
							<input type="checkbox" checked={$selectedRoles.has(role._id)} on:change={() => toggleRoleSelection(role._id)} class="mr-2" />
							{role.name} - {role.description}
							{#if role._id.toLowerCase() === 'admin'}<strong>(Admin)</strong>{/if}
							<ul class="ml-4">
								{#each role.permissions as permissionName}
									<li>{permissionName}</li>
								{/each}
							</ul>
						</li>
					{/each}
				</ul>
			{/if}
		</div>
	</div>
{/if}
